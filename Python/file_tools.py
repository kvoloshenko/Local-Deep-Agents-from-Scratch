"""
Virtual file system tools for agent state management.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tools) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π,
–∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≥–µ–Ω—Ç–∞ (agent state). –¢–∞–∫–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –≤—ã–Ω–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω–æ—ë–º–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ LLM;
- —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ –∞–≥–µ–Ω—Ç–∞;
- –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ LangGraph.

–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–µ—Ö–∞–Ω–∏–∑–º InjectedState ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
–ù–ï –∞–≥–µ–Ω—Ç–æ–º, –∞ —Å–∞–º–∏–º LangGraph –≤–æ –≤—Ç–æ—Ä–æ–º —É–∑–ª–µ (tool node).
"""

from typing import Annotated

from langchain_core.messages import ToolMessage
from langchain_core.tools import InjectedToolCallId, tool
from langgraph.prebuilt import InjectedState
from langgraph.types import Command

from prompts import (
    LS_DESCRIPTION,
    READ_FILE_DESCRIPTION,
    WRITE_FILE_DESCRIPTION,
)
from state import DeepAgentState


# ----------------------------------------------------------------------
# üóÇ 1. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ls ‚Äî –≤—ã–≤–æ–¥ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
# ----------------------------------------------------------------------
@tool(description=LS_DESCRIPTION)
def ls(state: Annotated[DeepAgentState, InjectedState]) -> list[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.

    –ü–æ—è—Å–Ω–µ–Ω–∏—è:
    - –ê—Ä–≥—É–º–µ–Ω—Ç `state` –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è LLM. –û–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
      LangGraph –∫–∞–∫ InjectedState.
    - –ú—ã —á–∏—Ç–∞–µ–º –∫–ª—é—á "files" –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –≠—Ç–æ —Å–ª–æ–≤–∞—Ä—å –≤–∏–¥–∞:
          { "path/to/file": "—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞" }
    """
    return list(state.get("files", {}).keys())


# ----------------------------------------------------------------------
# üìù 2. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: read_file ‚Äî —á—Ç–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
# ----------------------------------------------------------------------
@tool(description=READ_FILE_DESCRIPTION, parse_docstring=True)
def read_file(
    file_path: str,
    state: Annotated[DeepAgentState, InjectedState],
    offset: int = 0,
    limit: int = 2000,
) -> str:
    """
    –ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑—ã–≤–∞—Ç—å offset –∏ limit.

    Args:
        file_path: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –§–°
        state: —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –§–° (InjectedState ‚Äî –Ω–µ –≤–∏–¥–µ–Ω LLM)
        offset: –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, —Å –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—á–∏–Ω–∞—Ç—å —á—Ç–µ–Ω–∏–µ
        limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —á–∏—Ç–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–æ–∫
        - –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç / offset –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
    """

    # –î–æ—Å—Ç–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –§–°
    files = state.get("files", {})

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if file_path not in files:
        return f"Error: File '{file_path}' not found"

    content = files[file_path]

    # –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—É—Å—Ç–æ–π
    if not content:
        return "System reminder: File exists but has empty contents"

    # –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
    lines = content.splitlines()

    start_idx = offset
    end_idx = min(start_idx + limit, len(lines))

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: offset –±–æ–ª—å—à–µ –¥–ª–∏–Ω—ã —Ñ–∞–π–ª–∞
    if start_idx >= len(lines):
        return f"Error: Line offset {offset} exceeds file length ({len(lines)} lines)"

    result_lines = []

    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
    for i in range(start_idx, end_idx):
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —Å–ª—É—á–∞–π –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫)
        line_content = lines[i][:2000]
        # –ù—É–º–µ—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        result_lines.append(f"{i + 1:6d}\t{line_content}")

    # –°–∫–ª–µ–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç–µ–∫—Å—Ç
    return "\n".join(result_lines)


# ----------------------------------------------------------------------
# ‚úçÔ∏è 3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: write_file ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
# ----------------------------------------------------------------------
@tool(description=WRITE_FILE_DESCRIPTION, parse_docstring=True)
def write_file(
    file_path: str,
    content: str,
    state: Annotated[DeepAgentState, InjectedState],
    tool_call_id: Annotated[str, InjectedToolCallId],
) -> Command:
    """
    –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Ñ–∞–π–ª –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.

    Args:
        file_path: –ø—É—Ç—å —Ñ–∞–π–ª–∞
        content: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
        state: —Å–æ—Å—Ç–æ—è–Ω–∏–µ (InjectedState)
        tool_call_id: ID –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (InjectedToolCallId)
                      ‚Äî –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è LLM, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è LangGraph

    Returns:
        Command ‚Äî –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π:
          - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ (files –∏ messages)
          - –¥–æ–±–∞–≤–ª—è–µ—Ç ToolMessage –∫–∞–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è LLM
    """

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–≤–∞—Ä—å —Ñ–∞–π–ª–æ–≤
    files = state.get("files", {})

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (—Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º)
    files[file_path] = content

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º Command, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    return Command(
        update={
            "files": files,
            "messages": [
                # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LLM –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞
                ToolMessage(
                    f"Updated file {file_path}",
                    tool_call_id=tool_call_id
                )
            ],
        }
    )
