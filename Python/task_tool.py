"""Task delegation tools for context isolation through sub-agents.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á —Å—É–±–∞–≥–µ–Ω—Ç–∞–º ‚Äî –∫–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø Deep Agents.

–û—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–∏:
- –°—É–±–∞–≥–µ–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (—á–∏—Å—Ç–æ–µ –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π).
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–∑–∞—Å–æ—Ä–µ–Ω–∏–µ" –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
- –ö–∞–∂–¥—ã–π —Å—É–±–∞–≥–µ–Ω—Ç –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é system-–ø—Ä–æ–º–ø—Ç.
- –ì–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç —Å—É–±–∞–≥–µ–Ω—Ç—ã –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tool calls).
"""

from typing import Annotated, NotRequired
from typing_extensions import TypedDict

from langchain_core.messages import ToolMessage
from langchain_core.tools import BaseTool, InjectedToolCallId, tool
from langgraph.prebuilt import InjectedState  # –í LangGraph 1.0
from langchain.agents import create_agent  # –ù–æ–≤—ã–π API LangChain 1.0
from langchain_core.messages import ToolMessage, HumanMessage

from langgraph.types import Command

# from deep_agents_from_scratch.prompts import TASK_DESCRIPTION_PREFIX
from prompts import TASK_DESCRIPTION_PREFIX
# from deep_agents_from_scratch.state import DeepAgentState
from state import DeepAgentState


# ---------------------------------------------------------------------
# üß± –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—É–±–∞–≥–µ–Ω—Ç–∞
# ---------------------------------------------------------------------
class SubAgent(TypedDict):
    """
    –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å—É–±–∞–≥–µ–Ω—Ç–∞.

    name ‚Äî –∏–º—è —Å—É–±–∞–≥–µ–Ω—Ç–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –≥–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –µ–≥–æ –≤—ã–∑—ã–≤–∞—Ç—å  
    description ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–∫ –∏ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É–±–∞–≥–µ–Ω—Ç–∞)
    prompt ‚Äî system-–ø–æ–¥—Å–∫–∞–∑–∫–∞, —É–ø—Ä–∞–≤–ª—è—é—â–∞—è —Å—Ç–∏–ª–µ–º –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º —Å—É–±–∞–≥–µ–Ω—Ç–∞
    tools ‚Äî –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Å—Ç—Ä–æ–∫), –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—É–±–∞–≥–µ–Ω—Ç—É
             (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å—É–±–∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
    """
    name: str
    description: str
    prompt: str
    tools: NotRequired[list[str]]


# ---------------------------------------------------------------------
# üß© –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ task()
# ---------------------------------------------------------------------
def _create_task_tool(tools, subagents: list[SubAgent], model, state_schema):
    """
    –°–æ–∑–¥–∞—ë—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç task(), –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–ª–∞–≤–Ω–æ–º—É –∞–≥–µ–Ω—Ç—É
    –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏ —Å—É–±–∞–≥–µ–Ω—Ç–∞–º —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.

    –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è:
    - –≥–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç task(description, subagent_type)
    - –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω—É–∂–Ω—ã–π —Å—É–±–∞–≥–µ–Ω—Ç
    - —É —Å—É–±–∞–≥–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æHumanMessage(description)
    - —Å—É–±–∞–≥–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–æ
    - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –∫–∞–∫ ToolMessage

    Args:
        tools ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        subagents ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π SubAgent
        model ‚Äî LLM-–º–æ–¥–µ–ª—å, –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∏ —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤
        state_schema ‚Äî —Å—Ö–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ–±—ã—á–Ω–æ DeepAgentState)

    Returns:
        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç task(), –∫–æ—Ç–æ—Ä—ã–π –≥–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å
    """

    # ---------------------------------------------------------------
    # 1. –†–µ–≥–∏—Å—Ç—Ä —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤
    # ---------------------------------------------------------------
    agents = {}

    # ---------------------------------------------------------------
    # 2. –°–ª–æ–≤–∞—Ä—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ ‚Äî –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–æ–≤ tools
    # ---------------------------------------------------------------
    tools_by_name = {}
    for tool_ in tools:
        # –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è BaseTool, –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ tool()
        if not isinstance(tool_, BaseTool):
            tool_ = tool(tool_)
        tools_by_name[tool_.name] = tool_

    # ---------------------------------------------------------------
    # 3. –°–æ–∑–¥–∞—ë–º —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤
    # ---------------------------------------------------------------
    for _agent in subagents:

        # –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ —É–∫–∞–∑–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö
        if "tools" in _agent:
            _tools = [tools_by_name[t] for t in _agent["tools"]]
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            _tools = tools

        # –°–æ–∑–¥–∞—ë–º —Å—É–±–∞–≥–µ–Ω—Ç–∞
        agents[_agent["name"]] = create_agent(
            model,
            system_prompt=_agent["prompt"],  # —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Å—É–±–∞–≥–µ–Ω—Ç–∞
            tools=_tools,                    # –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            state_schema=state_schema        # —Å—Ö–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (DeepAgentState)
        )

    # ---------------------------------------------------------------
    # 4. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è help-–ø–æ–¥—Å–∫–∞–∑–∫–∏
    # ---------------------------------------------------------------
    other_agents_string = [
        f"- {_agent['name']}: {_agent['description']}" for _agent in subagents
    ]

    # ------------------------------------------------------------------
    # üõ† 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç task()
    # ------------------------------------------------------------------
    @tool(description=TASK_DESCRIPTION_PREFIX.format(other_agents=other_agents_string))
    def task(
        description: str,                           # –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–∑–∞–¥–∞–Ω–∏–µ —Å—É–±–∞–≥–µ–Ω—Ç—É)
        subagent_type: str,                         # –∫–∞–∫–æ–π —Å—É–±–∞–≥–µ–Ω—Ç –≤—ã–∑–≤–∞—Ç—å
        state: Annotated[DeepAgentState, InjectedState],    # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
        tool_call_id: Annotated[str, InjectedToolCallId],   # —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π ID –≤—ã–∑–æ–≤–∞
    ):
        """
        –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å—É–±–∞–≥–µ–Ω—Ç—É —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.

        –í–∞–∂–Ω–∞—è –∏–¥–µ—è:
        - —Å—É–±–∞–≥–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –° –ù–£–õ–Ø, –≤–æ–æ–±—â–µ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏
        - —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ (context pollution)
        - —Å—É–±–∞–≥–µ–Ω—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        """

        # ----------------------------------------------
        # –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–∞–∫–æ–π —Å—É–±–∞–≥–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
        # ----------------------------------------------
        if subagent_type not in agents:
            allowed = [f'`{k}`' for k in agents]
            return f"Error: invoked agent of type {subagent_type}, allowed types: {allowed}"

        # –ü–æ–ª—É—á–∞–µ–º —Å—É–±–∞–≥–µ–Ω—Ç
        sub_agent = agents[subagent_type]

        # ----------------------------------------------
        # üßº –°–æ–∑–¥–∞—ë–º –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–±–∞–≥–µ–Ω—Ç–∞
        # ----------------------------------------------
        # –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è!
        # state["messages"] = [{"role": "user", "content": description}]
        state["messages"] = [HumanMessage(content=description)]

        # ----------------------------------------------
        # ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ —Å—É–±–∞–≥–µ–Ω—Ç–∞ –≤ —ç—Ç–æ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        # ----------------------------------------------
        result = sub_agent.invoke(state)

        # ----------------------------------------------
        # ‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ Command-update
        # ----------------------------------------------
        return Command(
            update={
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ —Å—É–±–∞–≥–µ–Ω—Ç —á—Ç–æ-—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª)
                "files": result.get("files", {}),

                # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç —Å—É–±–∞–≥–µ–Ω—Ç–∞
                "messages": [
                    ToolMessage(
                        result["messages"][-1].content,  # —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å—É–±–∞–≥–µ–Ω—Ç–∞
                        tool_call_id=tool_call_id         # —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π ID
                    )
                ],
            }
        )

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    return task
